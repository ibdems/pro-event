{% extends "event/base.html" %}
{% load static %}

{% block content %}
<div class="container py-5">
    <div class="row mt-5">
        <div class="col-lg-10 mx-auto">
            <div class="card card-body border-0 shadow p-4 p-lg-5">
                <h1 class="h2">Faire une demande</h1>
                <p class="font-small text-muted">Veuillez completer les differents champs de chaque
                    étape pour effectuer votre demande.</p>

                {% if messages %}
                  {% for message in messages %}
                    <div class="alert alert-success text-black fw-bold mb-4">
                        {{message}}
                    </div>
                  {% endfor %}
                {% endif %}
                <!-- Afficher les erreurs générales -->
                {% if form.non_field_errors %}
                <div class="alert alert-danger text-black fw-bold mb-4">
                    {% for error in form.non_field_errors %}
                    <li>{{ error }}</li>
                    {% endfor %}
                </div>
                {% endif %}

                {% if event_forms.errors or ticket_forms.errors or service_hotesse_forms.errors %}
                <div class="alert alert-danger mb-4">
                    Des erreurs ont été détectées dans l'étape 2. Veuillez vérifier les champs en rouge.
                </div>
                {% endif %}

                <!-- Erreurs de l'étape 3 -->
                {% if not user.is_authenticated and anonymous_user_forms.errors %}
                <div class="alert alert-danger mb-4">
                    Des erreurs ont été détectées dans l'étape 3. Veuillez vérifier les champs en rouge.
                </div>
                {% endif %}

                <form method="POST" enctype="multipart/form-data" id="serviceForm">
                    {% csrf_token %}

                    <!-- Progress Steps -->
                    <div class="step-progress mb-5">
                        <div class="progress position-relative mb-4">
                            <div class="progress-bar" role="progressbar" id="stepProgress"></div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <div class="step active">
                                <div class="step-number">1</div>
                                <div class="step-title">Services</div>
                            </div>
                            <div class="step">
                                <div class="step-number">2</div>
                                <div class="step-title">Détails</div>
                            </div>
                            <div class="step">
                                <div class="step-number">3</div>
                                <div class="step-title">Informations</div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 1: Services -->
                    <div class="step-container active" id="step1">
                        <h3 class="mb-4">Sélectionnez vos services</h3>
                        <div class="row g-4">
                            {% for service in services %}
                            <div class="col-12 col-md-4">
                                <div class="service-card h-100" data-service="{{ service.accronyme|lower }}">
                                    <div class="selected-indicator">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                    <h4 class="mb-3">{{ service.name }}</h4>
                                    <p class="mb-0">{{ service.description }}</p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <input type="hidden" name="selected_services" id="selectedServices">

                    <!-- Step 2: Service Details -->
                    <div class="step-container" id="step2">
                        <!-- Event Organization Form -->
                        <div id="eventForm" style="display: none;">
                            <h3 class="mb-4">Détails de l'événement</h3>
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <label class="form-label">Titre de l'événement</label>
                                    <input type="text" name="title" class="form-control">
                                    {% if errors.event.title %}
                                    <div class="text-danger">{{ errors.event.title }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Catégorie</label>
                                    <select name="category" class="form-control">
                                        {% for category in categories %}
                                        <option value="{{ category.id }}">{{ category.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Description</label>
                                    <textarea name="description" class="form-control" rows="4"></textarea>
                                    {% if errors.event.description %}
                                    <div class="text-danger">{{ errors.event.description }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Date de début</label>
                                    <input type="datetime-local" name="start_date" class="form-control">
                                    {% if errors.event.start_date %}
                                    <div class="text-danger">{{ errors.event.start_date }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Date de fin</label>
                                    <input type="datetime-local" name="end_date" class="form-control">
                                    {% if errors.event.end_date %}
                                    <div class="text-danger">{{ errors.event.end_date }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Lieu</label>
                                    <input type="text" name="location" class="form-control">
                                    {% if errors.event.location %}
                                    <div class="text-danger">{{ errors.event.location }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Type d'événement</label>
                                    <select name="type_event" class="form-control">
                                        <option value="public">Public</option>
                                        <option value="private">Privé</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Image de l'événement</label>
                                    <input type="file" name="image" class="form-control" accept="image/*">
                                    {% if errors.event.image %}
                                    <div class="text-danger">{{ errors.event.image }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Ticket Section -->
                        <div id="ticketForm" style="display: none;">
                            <h4 class="col-12 mt-4">Details des tickets</h4>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Capacité Normal</label>
                                    <input type="number" name="normal_capacity" class="form-control" min="0">
                                    {% if errors.ticket.normal_capacity %}
                                    <div class="text-danger">{{ errors.ticket.normal_capacity }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Prix Normal</label>
                                    <input type="number" name="prix_normal" class="form-control" min="0">
                                    {% if errors.ticket.prix_normal %}
                                    <div class="text-danger">{{ errors.ticket.prix_normal }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Capacité VIP</label>
                                    <input type="number" name="vip_capacity" class="form-control" min="0">
                                    {% if errors.ticket.vip_capacity %}
                                    <div class="text-danger">{{ errors.ticket.vip_capacity }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Prix VIP</label>
                                    <input type="number" name="prix_vip" class="form-control" min="0">
                                    {% if errors.ticket.prix_vip %}
                                    <div class="text-danger">{{ errors.ticket.prix_vip }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Capacité VVIP</label>
                                    <input type="number" name="vvip_capacity" class="form-control" min="0">
                                    {% if errors.ticket.vvip_capacity %}
                                    <div class="text-danger">{{ errors.ticket.vvip_capacity }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Prix VVIP</label>
                                    <input type="number" name="prix_vvip" class="form-control" min="0">
                                    {% if errors.ticket.prix_vvip %}
                                    <div class="text-danger">{{ errors.ticket.prix_vvip }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Hostess Service Form -->
                        <div id="hostessForm" style="display: none;">
                            <h3 class="mb-4">Service d'hôtesse</h3>
                            <div class="row g-4">
                                <div class="col-md-4">
                                    <label class="form-label">Nombre d'hôtesses</label>
                                    <input type="number" name="number_hotesse" class="form-control" min="1">
                                    {% if errors.hostess.number_hotesse %}
                                    <div class="text-danger">{{ errors.hostess.number_hotesse }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Date de début</label>
                                    <input type="datetime-local" name="start_date_hotesse" class="form-control">
                                    {% if errors.hostess.start_date_hotesse %}
                                    <div class="text-danger">{{ errors.hostess.start_date_hotesse }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Date de fin</label>
                                    <input type="datetime-local" name="end_date_hotesse" class="form-control">
                                    {% if errors.hostess.end_date_hotesse %}
                                    <div class="text-danger">{{ errors.hostess.end_date_hotesse }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Besoins particuliers</label>
                                    <textarea name="besoin" class="form-control" rows="4"
                                        placeholder="Précisez vos besoins (tenue, langues parlées, origine...)"></textarea>
                                    {% if errors.hostess.besoin %}
                                    <div class="text-danger">{{ errors.hostess.besoin }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Personal Information -->
                    {% if not user.is_authenticated %}
                    <div class="step-container" id="step3">
                        <h3 class="mb-4">Vos informations</h3>
                        <div class="row g-4">
                            <div class="col-md-6">
                                <label class="form-label">Prénom</label>
                                <input type="text" name="first_name" class="form-control" required>
                                {% if errors.anonymous_user.first_name %}
                                <div class="text-danger">{{ errors.anonymous_user.first_name }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Nom</label>
                                <input type="text" name="last_name" class="form-control" required>
                                {% if errors.anonymous_user.last_name %}
                                <div class="text-danger">{{ errors.anonymous_user.last_name }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Email</label>
                                <input type="email" name="email" class="form-control" required>
                                {% if errors.anonymous_user.email %}
                                <div class="text-danger">{{ errors.anonymous_user.email }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Contact</label>
                                <input type="tel" name="contact" class="form-control" required>
                                {% if errors.anonymous_user.contact %}
                                <div class="text-danger">{{ errors.anonymous_user.contact }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Navigation Buttons -->
                    <div class="d-flex justify-content-center gap-3 mt-4">
                        <button type="button" class="btn btn-outline-primary" id="prevBtn" style="display: none;">Précédent</button>
                        <button type="button" class="btn btn-primary" id="nextBtn">Suivant</button>
                        <button type="submit" class="btn btn-success" id="submitBtn" style="display: none;">Soumettre</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    let currentStep = 1;
    const totalSteps = {{ user.is_authenticated|yesno:"2,3" }};
    const selectedServices = new Set();

    function updateStep(step) {
        document.querySelectorAll('.step-container').forEach(container => {
            container.classList.remove('active');
        });
        document.querySelector(`#step${step}`).classList.add('active');

        document.querySelectorAll('.step').forEach((stepEl, index) => {
            if (index + 1 < step) {
                stepEl.classList.add('completed');
                stepEl.classList.remove('active');
            } else if (index + 1 === step) {
                stepEl.classList.add('active');
                stepEl.classList.remove('completed');
            } else {
                stepEl.classList.remove('active', 'completed');
            }
        });

        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');

        prevBtn.style.display = step > 1 ? 'block' : 'none';
        if (step === totalSteps) {
            nextBtn.style.display = 'none';
            submitBtn.style.display = 'block';
        } else {
            nextBtn.style.display = 'block';
            submitBtn.style.display = 'none';
        }

        // Update progress bar
        const progress = ((step - 1) / (totalSteps - 1)) * 100;
        document.getElementById('stepProgress').style.width = `${progress}%`;
    }

    // Service card selection with visual feedback
    document.querySelectorAll('.service-card').forEach(card => {
        card.addEventListener('click', () => {
            card.classList.toggle('selected');
            const service = card.dataset.service;
            if (selectedServices.has(service)) {
                selectedServices.delete(service);
            } else {
                selectedServices.add(service);
            }
            document.getElementById('selectedServices').value = Array.from(selectedServices).join(',');
        });
    });

    // Navigation
    document.getElementById('prevBtn').addEventListener('click', () => {
        if (currentStep > 1) {
            currentStep--;
            updateStep(currentStep);
        }
    });

    document.getElementById('nextBtn').addEventListener('click', () => {
        if (currentStep < totalSteps) {
            if (currentStep === 1 && selectedServices.size === 0) {
                alert('Veuillez sélectionner au moins un service');
                return;
            }
            currentStep++;
            updateStep(currentStep);

            if (currentStep === 2) {
                document.getElementById('eventForm').style.display =
                    selectedServices.has('event') || selectedServices.has('ticket') ? 'block' : 'none';
                document.getElementById('ticketForm').style.display =
                    selectedServices.has('ticket') ? 'block' : 'none';
                document.getElementById('hostessForm').style.display =
                    selectedServices.has('hostess') ? 'block' : 'none';
            }
        }
    });
</script>

{% endblock content %}